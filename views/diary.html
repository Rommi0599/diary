<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <title>æˆ‘çš„æ—¥è¨˜</title>
  <link href="stylesheet.css" rel="stylesheet">
</head>

<body>
  <h1>æˆ‘çš„æ—¥è¨˜</h1>
  <form id="diaryForm">
    <label>æ—¥æœŸï¼š<input type="date" name="date" required></label><br><br>
    <label>å¿ƒæƒ…åˆ†æ•¸ï¼š
      <select name="score">
        <option value="1">ğŸ˜¢ 1</option>
        <option value="2">ğŸ˜ 2</option>
        <option value="3">ğŸ˜ 3</option>
        <option value="4">ğŸ˜Š 4</option>
        <option value="5">ğŸ˜ 5</option>
      </select>
    </label><br><br>
    <label>å¿ƒæƒ…ï¼š
      <input type="text" name="emoji" placeholder="ä¾‹å¦‚ï¼šè¶…é–‹å¿ƒ">
    </label><br><br>
    <label>æ—¥è¨˜å…§å®¹ï¼š<br>
      <textarea name="content" rows="4" cols="40"></textarea>
    </label><br><br>
    <button type="submit">å„²å­˜æ—¥è¨˜</button>
  </form>

  <h2>æ¯æ—¥è¨˜éŒ„</h2>
  <div style="text-align:center;margin-bottom:1em;">
    <input type="date" id="searchDate">
    <input type="text" id="searchKeyword" placeholder="æœå°‹å…§å®¹">
    <button id="searchBtn">æœå°‹</button>
    <button id="clearSearchBtn">æ¸…é™¤</button>
  </div>
  <div id="diaryList"></div>
  <div id="pagination" style="text-align:center;margin:1em 0;"></div>
  <a href="index.html">å›é¦–é </a>

  <script>
    let diaries = [];
    let currentPage = 1;
    const pageSize = 5;

    // é€å‡ºæ—¥è¨˜
    document.getElementById('diaryForm').addEventListener('submit', function (e) {
      e.preventDefault();
      const form = e.target;
      const user_id = localStorage.getItem('user_id');
      if (!user_id) {
        alert('è«‹å…ˆç™»å…¥ï¼');
        return;
      }
      const data = {
        user_id: user_id,
        date: form.date.value,
        mood_score: form.score.value,
        mood_emoji: form.emoji.value,
        content: form.content.value
      };
      fetch('/addDiary', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
        .then(res => res.json())
        .then(result => {
          if (result.success) {
            alert('æ—¥è¨˜å„²å­˜æˆåŠŸï¼');
            form.reset();
            fetchDiaries();
          } else {
            alert('å„²å­˜å¤±æ•—ï¼š' + result.message);
          }
        })
    });

    // å–å¾—è‡ªå·±çš„æ—¥è¨˜
    function fetchDiaries() {
      const user_id = localStorage.getItem('user_id');
      if (!user_id) {
        alert('è«‹å…ˆç™»å…¥ï¼');
        document.getElementById('diaryList').innerHTML = '<div style="color:#ef8f8f;text-align:center;">è«‹å…ˆç™»å…¥æ‰èƒ½æŸ¥çœ‹è‡ªå·±çš„æ—¥è¨˜ï¼</div>';
        return;
      }
      fetch('/diaries?user_id=' + encodeURIComponent(user_id))
        .then(res => res.json())
        .then(data => {
          diaries = data.diaries;
          currentPage = 1;
          renderDiaries();
        });
    }

    // åˆ†é èˆ‡æœå°‹
    function renderDiaries() {
      let filtered = diaries;
      const searchDate = document.getElementById('searchDate').value;
      const keyword = document.getElementById('searchKeyword').value.trim();
      if (searchDate) {
        filtered = filtered.filter(d => d.date === searchDate);
      }
      if (keyword) {
        filtered = filtered.filter(d => d.content.includes(keyword) || (d.mood_emoji && d.mood_emoji.includes(keyword)));
      }
      const total = filtered.length;
      const totalPages = Math.ceil(total / pageSize) || 1;
      if (currentPage > totalPages) currentPage = totalPages;
      const start = (currentPage - 1) * pageSize;
      const pageData = filtered.slice(start, start + pageSize);

      const diaryList = document.getElementById('diaryList');
      diaryList.innerHTML = '';
      if (pageData.length === 0) {
        diaryList.innerHTML = '<div style="color:#888;text-align:center;">æŸ¥ç„¡è³‡æ–™</div>';
      }
      pageData.forEach(diary => {
        const div = document.createElement('div');
        div.className = 'diary-item';
        div.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div>
              <b style="color:#ef8f8f;font-size:1.1em;">${diary.date}</b>
              <span style="margin-left:1em;">å¿ƒæƒ…åˆ†æ•¸ï¼š<b>${diary.mood_score}</b></span>
              <span style="margin-left:1em;">${diary.mood_emoji ? 'Emojiï¼š<b>' + diary.mood_emoji + '</b>' : ''}</span>
            </div>
            <div>
              <button class="edit-btn" onclick="editDiary(${diary.id})">ç·¨è¼¯</button>
              <button class="delete-btn" onclick="deleteDiary(${diary.id})">åˆªé™¤</button>
            </div>
          </div>
          <div style="margin-top:0.5em;">${diary.content.replace(/\n/g, '<br>')}</div>
        `;
        diaryList.appendChild(div);
      });

      // åˆ†é æŒ‰éˆ•
      let pagHtml = `<span style="color:#888;">å…± ${total} ç­†ï¼Œé æ¬¡ ${currentPage}/${totalPages}</span><br>`;
      pagHtml += `<button onclick="gotoPage(1)" ${currentPage === 1 ? 'disabled' : ''}>é¦–é </button>`;
      pagHtml += `<button onclick="gotoPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>ä¸Šä¸€é </button>`;
      pagHtml += `<button onclick="gotoPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>ä¸‹ä¸€é </button>`;
      pagHtml += `<button onclick="gotoPage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>æœ«é </button>`;
      document.getElementById('pagination').innerHTML = pagHtml;
    }

    // åˆ†é è·³è½‰
    window.gotoPage = function (page) {
      currentPage = page;
      renderDiaries();
    };

    // æœå°‹
    document.getElementById('searchBtn').onclick = function () {
      currentPage = 1;
      renderDiaries();
    };
    document.getElementById('clearSearchBtn').onclick = function () {
      document.getElementById('searchDate').value = '';
      document.getElementById('searchKeyword').value = '';
      currentPage = 1;
      renderDiaries();
    };

    // åˆªé™¤æ—¥è¨˜
    window.deleteDiary = function (id) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç¯‡æ—¥è¨˜å—ï¼Ÿ')) return;
      fetch('/diary/' + id, { method: 'DELETE' })
        .then(res => res.json())
        .then(result => {
          if (result.success) {
            fetchDiaries();
          } else {
            alert('åˆªé™¤å¤±æ•—');
          }
        });
    };

    // ç·¨è¼¯æ—¥è¨˜
    window.editDiary = function (id) {
      const diary = diaries.find(d => d.id === id);
      if (!diary) return;
      const newContent = prompt('è«‹è¼¸å…¥æ–°çš„æ—¥è¨˜å…§å®¹ï¼š', diary.content);
      if (newContent !== null) {
        fetch('/diary/' + id, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content: newContent })
        })
          .then(res => res.json())
          .then(result => {
            if (result.success) fetchDiaries();
            else alert('ç·¨è¼¯å¤±æ•—');
          });
      }
    };

    document.addEventListener('DOMContentLoaded', fetchDiaries);
  </script>
</body>

</html>