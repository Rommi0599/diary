<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <title>æˆ‘çš„æ—¥è¨˜</title>
  <link href="stylesheet.css" rel="stylesheet">
</head>

<body>
  <h1>æˆ‘çš„æ—¥è¨˜</h1>
  <form id="diaryForm">
    <label>æ—¥æœŸï¼š<input type="date" name="date" required></label><br><br>
    <label>å¿ƒæƒ…åˆ†æ•¸ï¼š
      <select name="score">
        <option value="1">ğŸ˜¢ 1</option>
        <option value="2">ğŸ˜ 2</option>
        <option value="3">ğŸ˜ 3</option>
        <option value="4">ğŸ˜Š 4</option>
        <option value="5">ğŸ˜ 5</option>
      </select>
    </label><br><br>
    <label>å¿ƒæƒ…ï¼š
      <input type="text" name="describe" placeholder="ä¾‹å¦‚ï¼šé–‹å¿ƒã€ç·Šå¼µã€ç–²å€¦">
    </label><br><br>
    <label>æ—¥è¨˜å…§å®¹ï¼š<br>
      <textarea name="content" rows="4" cols="40"></textarea>
    </label><br><br>
    <button type="submit">å„²å­˜æ—¥è¨˜</button>
  </form>

  <h2>æ¯æ—¥è¨˜éŒ„</h2>
  <div style="text-align:center;margin-bottom:1em;">
    <input type="date" id="searchDate">
    <input type="text" id="searchKeyword" placeholder="æœå°‹å…§å®¹">
    <button id="searchBtn">æœå°‹</button>
    <button id="clearSearchBtn">æ¸…é™¤</button>
  </div>
  <div id="diaryList"></div>
  <div id="pagination" style="text-align:center;margin:1em 0;"></div>
  <a href="index.html">å›é¦–é </a>

  <script>
    // ====== å…¨åŸŸè®Šæ•¸ ======
    let blogs = [];         // æ‰€æœ‰æ–‡ç« 
    let comments = {};      // ç•™è¨€å¿«å–
    let currentPage = 1;    // ç•¶å‰é ç¢¼
    const pageSize = 5;     // æ¯é é¡¯ç¤ºå¹¾ç¯‡

    // ====== å–å¾—æ‰€æœ‰æ–‡ç«  ======
    function fetchBlogs() {
      fetch('/blogs')
        .then(res => res.json())
        .then(data => {
          blogs = data.blogs;
          currentPage = 1; // é‡ç½®é ç¢¼
          renderBlogs();   // æ¸²æŸ“æ–‡ç« åˆ—è¡¨
          renderCategoryOptions(); // æ¸²æŸ“åˆ†é¡é¸å–®
        });
    }

    // ====== å–å¾—ç•™è¨€ ======
    function fetchComments(blogId, callback) {
      fetch(`/comments?blog_id=${blogId}`)
        .then(res => res.json())
        .then(data => {
          comments[blogId] = data.comments || [];
          if (callback) callback();
        });
    }

    // ====== æ¸²æŸ“æ–‡ç« åˆ—è¡¨ ======
    function renderBlogs() {
      const category = document.getElementById('categoryFilter')?.value || '';
      let filtered = blogs;
      if (category) {
        filtered = filtered.filter(b => b.category === category);
      }
      const total = filtered.length;
      const totalPages = Math.ceil(total / pageSize) || 1;
      if (currentPage > totalPages) currentPage = totalPages;
      const start = (currentPage - 1) * pageSize;
      const pageData = filtered.slice(start, start + pageSize);

      const blogList = document.getElementById('blogList');
      blogList.innerHTML = '';
      if (pageData.length === 0) {
        blogList.innerHTML = '<div style="color:#888;text-align:center;">æŸ¥ç„¡è³‡æ–™</div>';
      }
      pageData.forEach(blog => {
        const div = document.createElement('div');
        div.className = 'post';
        div.innerHTML = `
        <img class="cover" src="${blog.cover_url || 'https://picsum.photos/100/60'}" alt="å°é¢åœ–">
        <strong>${blog.title}</strong>
        <div class="tags">åˆ†é¡ï¼š${blog.category || ''}ï¼Œæ¨™ç±¤ï¼š${blog.tags || ''}</div>
        <p class="summary">${blog.summary || ''}</p>
        <div class="full-content" style="display:none;">${blog.content.replace(/\n/g, '<br>')}</div>
        <button class="toggle-btn" onclick="toggleContent(this)">å…¨æ–‡</button>
        <div style="color:#aaa;font-size:0.9em;">
          ${blog.created_at ? 'ç™¼è¡¨æ–¼ï¼š' + blog.created_at : ''}ã€€ä½œè€…ï¼š${blog.username || ''}
        </div>
        ${blog.user_id == localStorage.getItem('user_id') ? `
          <button onclick="editBlog(${blog.id})">ç·¨è¼¯</button>
          <button onclick="deleteBlog(${blog.id})">åˆªé™¤</button>
        ` : ''}
        <div class="comments" id="comments-${blog.id}" style="margin-top:1em;"></div>
        <form class="commentForm" data-blogid="${blog.id}" style="margin-top:0.5em;">
          <input type="text" name="content" placeholder="ç•™è¨€..." style="width:60%;" required>
          <button type="submit">é€å‡ºç•™è¨€</button>
        </form>
      `;
        blogList.appendChild(div);
        // å–å¾—ç•™è¨€
        fetchComments(blog.id, () => renderComments(blog.id));
      });

      // ====== åˆ†é æŒ‰éˆ• ======
      let pagHtml = `<span style="color:#888;">å…± ${total} ç­†ï¼Œé æ¬¡ ${currentPage}/${totalPages}</span><br>`;
      pagHtml += `<button onclick="gotoPage(1)" ${currentPage === 1 ? 'disabled' : ''}>é¦–é </button>`;
      pagHtml += `<button onclick="gotoPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>ä¸Šä¸€é </button>`;
      pagHtml += `<button onclick="gotoPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>ä¸‹ä¸€é </button>`;
      pagHtml += `<button onclick="gotoPage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>æœ«é </button>`;
      document.getElementById('pagination').innerHTML = pagHtml;

      // ====== ç¶å®šç•™è¨€è¡¨å–®é€å‡ºäº‹ä»¶ ======
      document.querySelectorAll('.commentForm').forEach(form => {
        form.onsubmit = function (e) {
          e.preventDefault();
          const blog_id = this.getAttribute('data-blogid');
          const user_id = localStorage.getItem('user_id');
          if (!user_id) {
            alert('è«‹å…ˆç™»å…¥æ‰èƒ½ç•™è¨€');
            return;
          }
          const content = this.content.value.trim();
          if (!content) return;
          fetch('/addComment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ blog_id, user_id, content })
          })
            .then(res => res.json())
            .then(result => {
              if (result.success) {
                this.reset();
                fetchComments(blog_id, () => renderComments(blog_id));
              } else {
                alert('ç•™è¨€å¤±æ•—');
              }
            });
        };
      });
    }

    // ====== æ¸²æŸ“ç•™è¨€ ======
    function renderComments(blogId) {
      const box = document.getElementById('comments-' + blogId);
      const list = comments[blogId] || [];
      if (!box) return;
      if (list.length === 0) {
        box.innerHTML = '<div style="color:#aaa;font-size:0.95em;">æš«ç„¡ç•™è¨€</div>';
      } else {
        box.innerHTML = list.map(c =>
          `<div style="border-bottom:1px solid #eee;padding:0.3em 0;">
          <b style="color:#ef8f8f;">${c.username || 'åŒ¿å'}</b>ï¼š${c.content}
          <span style="color:#aaa;font-size:0.85em;margin-left:1em;">${c.created_at ? c.created_at.slice(0, 16).replace('T', ' ') : ''}</span>
        </div>`
        ).join('');
      }
    }

    // ====== åˆ†é è·³è½‰ ======
    window.gotoPage = function (page) {
      currentPage = page;
      renderBlogs();
    };

    // ====== å±•é–‹/æ”¶åˆå…¨æ–‡ ======
    window.toggleContent = function (btn) {
      const summary = btn.parentElement.querySelector('.summary');
      const full = btn.parentElement.querySelector('.full-content');
      if (full.style.display === 'none') {
        full.style.display = '';
        summary.style.display = 'none';
        btn.textContent = 'æ”¶åˆ';
      } else {
        full.style.display = 'none';
        summary.style.display = '';
        btn.textContent = 'å…¨æ–‡';
      }
    };

    // ====== åˆ†é¡é¸å–® ======
    function renderCategoryOptions() {
      const categories = Array.from(new Set(blogs.map(b => b.category).filter(Boolean)));
      let html = `<select id="categoryFilter"><option value="">å…¨éƒ¨åˆ†é¡</option>`;
      categories.forEach(c => html += `<option value="${c}">${c}</option>`);
      html += `</select>`;
      document.getElementById('categoryFilterBox').innerHTML = html;
      document.getElementById('categoryFilter').onchange = () => { currentPage = 1; renderBlogs(); };
    }

    // ====== æ–‡ç« ç™¼è¡¨ ======
    document.getElementById('blogForm').addEventListener('submit', function (e) {
      e.preventDefault();
      const form = e.target;
      const user_id = localStorage.getItem('user_id');
      if (!user_id) {
        alert('è«‹å…ˆç™»å…¥ï¼');
        return;
      }
      const data = {
        title: form.title.value,
        category: form.category.value,
        tags: form.tags.value,
        cover_url: form.cover_url.value,
        summary: form.summary.value,
        content: form.content.value,
        user_id: user_id
      };
      fetch('/addBlog', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
        .then(res => res.json())
        .then(result => {
          alert(result.message);
          form.reset();
          fetchBlogs();
        });
    });

    // ====== åˆªé™¤æ–‡ç«  ======
    function deleteBlog(id) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç¯‡æ–‡ç« ï¼Ÿ')) return;
      fetch('/blog/' + id, { method: 'DELETE' })
        .then(res => res.json())
        .then(result => {
          alert(result.success ? 'åˆªé™¤æˆåŠŸ' : 'åˆªé™¤å¤±æ•—');
          fetchBlogs();
        });
    }

    // ====== ç·¨è¼¯æ–‡ç«  ======
    function editBlog(id) {
      const blog = blogs.find(b => b.id === id);
      if (!blog) return;
      const newTitle = prompt('æ–°æ¨™é¡Œ', blog.title);
      if (newTitle !== null) {
        fetch('/blog/' + id, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ...blog, title: newTitle })
        })
          .then(res => res.json())
          .then(result => {
            alert(result.success ? 'ä¿®æ”¹æˆåŠŸ' : 'ä¿®æ”¹å¤±æ•—');
            fetchBlogs();
          });
      }
    }

    // è®“å…¨åŸŸå¯å‘¼å«
    window.deleteBlog = deleteBlog;
    window.editBlog = editBlog;

    // ====== é é¢è¼‰å…¥æ™‚è‡ªå‹•å–å¾—æ–‡ç«  ======
    document.addEventListener('DOMContentLoaded', fetchBlogs);

    // ====== åœ–ç‰‡é»æ“Šæ”¾å¤§ ======
    document.addEventListener('click', function (e) {
      if (e.target.classList.contains('cover')) {
        const src = e.target.src;
        let modal = document.getElementById('imgModal');
        if (!modal) {
          modal = document.createElement('div');
          modal.id = 'imgModal';
          modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:9999;';
          modal.innerHTML = `<img id="modalImg" style="max-width:90vw;max-height:80vh;border-radius:10px;box-shadow:0 0 20px #000;">
          <span style="position:absolute;top:30px;right:50px;font-size:2em;color:#fff;cursor:pointer;" id="closeModal">&times;</span>`;
          document.body.appendChild(modal);
          modal.addEventListener('click', function (ev) {
            if (ev.target === modal || ev.target.id === 'closeModal') modal.style.display = 'none';
          });
        }
        document.getElementById('modalImg').src = src;
        modal.style.display = 'flex';
      }
    });
  </script>
</body>

</html>